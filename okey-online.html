<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okey Oyunu - Online Multiplayer</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        :root {
            --primary: #1a5f3c;
            --primary-dark: #0d3d25;
            --accent: #ffd700;
            --red: #e53935;
            --blue: #1e88e5;
            --yellow: #fbc02d;
            --black: #424242;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary), #2e7d32);
            min-height: 100vh;
        }

        #main-menu {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .menu-logo {
            font-size: 4rem;
            font-weight: 700;
            color: var(--accent);
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
            margin-bottom: 1rem;
            letter-spacing: 8px;
        }

        .menu-subtitle {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
        }

        .menu-container {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-btn {
            display: block;
            width: 280px;
            padding: 18px 30px;
            margin: 12px 0;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .menu-btn.primary {
            background: linear-gradient(135deg, var(--accent), #ffb300);
            color: #1a1a1a;
        }

        .menu-btn.secondary {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
        }

        .menu-btn:hover {
            transform: translateY(-3px);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(145deg, #1e1e1e, #2d2d2d);
            border-radius: 20px;
            padding: 2rem;
            min-width: 350px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal h2 {
            color: var(--accent);
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .online-input {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .online-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .room-code {
            background: rgba(255, 215, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
        }

        .room-code .code {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 8px;
        }

        .room-code .hint {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        .players-list {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .player-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
        }

        .player-slot.filled {
            background: rgba(76, 175, 80, 0.3);
        }

        .player-slot .avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #1a1a1a;
        }

        .player-slot .name {
            color: white;
            flex: 1;
        }

        .player-slot .status {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .player-slot.filled .status {
            color: #4caf50;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.confirm {
            background: linear-gradient(135deg, var(--accent), #ffb300);
            color: #1a1a1a;
        }

        .modal-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .bot-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .bot-option {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
        }

        .bot-option.selected {
            background: rgba(255, 215, 0, 0.3);
            border-color: var(--accent);
        }

        .bot-option .number {
            font-size: 2rem;
            font-weight: 700;
        }

        .bot-option .label {
            font-size: 0.7rem;
        }

        #game-area {
            display: none;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #game-area.active {
            display: block;
        }

        .player-area {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-info {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 2px solid transparent;
        }

        .player-info.active {
            border-color: var(--accent);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
        }

        .player-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #ffb300);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            color: #1a1a1a;
        }

        .player-details {
            color: white;
        }

        .player-name {
            font-weight: 600;
        }

        .player-tiles {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        #player-bottom {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: column;
        }

        #player-top {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        #player-left {
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        #player-right {
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .tile-rack {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            max-width: 800px;
            justify-content: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
        }

        .tile {
            width: 45px;
            height: 60px;
            background: linear-gradient(180deg, #fff, #f5f5f5);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        .tile:hover {
            transform: translateY(-8px);
        }

        .tile.selected {
            transform: translateY(-15px);
            border: 3px solid var(--accent);
        }

        .tile.red {
            color: var(--red);
        }

        .tile.blue {
            color: var(--blue);
        }

        .tile.yellow {
            color: var(--yellow);
        }

        .tile.black {
            color: var(--black);
        }

        .tile.back {
            background: linear-gradient(135deg, #8b4513, #a0522d);
        }

        .tile.back::before {
            content: '‚¨•';
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.3);
        }

        #center-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 30px;
            align-items: center;
        }

        #indicator-tile {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        #indicator-tile .label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .pile {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .pile-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        .pile-count {
            background: rgba(0, 0, 0, 0.5);
            color: var(--accent);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        #controls {
            position: absolute;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }

        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .control-btn.sort {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
        }

        .control-btn.okey {
            background: linear-gradient(135deg, var(--accent), #ffb300);
            color: #1a1a1a;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #turn-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: var(--accent);
            padding: 15px 40px;
            border-radius: 30px;
            font-weight: 600;
            display: none;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
            z-index: 2000;
            text-align: center;
        }

        .status-bar {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 20px;
            border-radius: 20px;
            color: white;
            font-size: 0.85rem;
            z-index: 100;
        }

        .status-bar.connected {
            background: rgba(76, 175, 80, 0.8);
        }

        .status-bar.disconnected {
            background: rgba(244, 67, 54, 0.8);
        }

        @media (max-width: 768px) {
            .menu-logo {
                font-size: 2.5rem;
            }

            .tile {
                width: 35px;
                height: 48px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>

<body>
    <div id="status-bar" class="status-bar">üîÑ Baƒülanƒ±yor...</div>

    <div id="main-menu">
        <div class="menu-logo">OKEY</div>
        <div class="menu-subtitle">Online Multiplayer</div>
        <div class="menu-container">
            <button class="menu-btn primary" onclick="showBotModal()">üéÆ TEK OYUNCU</button>
            <button class="menu-btn secondary" onclick="showCreateModal()">üåê ODA OLU≈ûTUR</button>
            <button class="menu-btn secondary" onclick="showJoinModal()">üîó ODAYA KATIL</button>
        </div>
    </div>

    <div id="bot-modal" class="modal-overlay">
        <div class="modal">
            <h2>ü§ñ Bot Sayƒ±sƒ±nƒ± Se√ß</h2>
            <div class="bot-options">
                <div class="bot-option" data-bots="1" onclick="selectBots(1)">
                    <div class="number">1</div>
                    <div class="label">Bot</div>
                </div>
                <div class="bot-option selected" data-bots="2" onclick="selectBots(2)">
                    <div class="number">2</div>
                    <div class="label">Bot</div>
                </div>
                <div class="bot-option" data-bots="3" onclick="selectBots(3)">
                    <div class="number">3</div>
                    <div class="label">Bot</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal('bot-modal')">ƒ∞ptal</button>
                <button class="modal-btn confirm" onclick="startOfflineGame()">Ba≈üla</button>
            </div>
        </div>
    </div>

    <div id="create-modal" class="modal-overlay">
        <div class="modal">
            <h2>üåê Oda Olu≈ütur</h2>
            <input type="text" class="online-input" id="host-name" placeholder="Adƒ±nƒ±zƒ± girin..." maxlength="12">
            <div class="room-code" id="room-display" style="display:none;">
                <div class="hint">Oda Kodu</div>
                <div class="code" id="room-code-text">----</div>
                <div class="hint">Bu kodu arkada≈ülarƒ±nƒ±zla payla≈üƒ±n</div>
            </div>
            <div class="players-list" id="host-players" style="display:none;"></div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="leaveRoom()">ƒ∞ptal</button>
                <button class="modal-btn confirm" id="create-btn" onclick="createRoom()">Oda Olu≈ütur</button>
            </div>
        </div>
    </div>

    <div id="join-modal" class="modal-overlay">
        <div class="modal">
            <h2>üîó Odaya Katƒ±l</h2>
            <input type="text" class="online-input" id="guest-name" placeholder="Adƒ±nƒ±zƒ± girin..." maxlength="12">
            <input type="text" class="online-input" id="room-input" placeholder="Oda kodunu girin..." maxlength="4"
                style="text-transform:uppercase; letter-spacing:5px; font-size:1.5rem;">
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal('join-modal')">ƒ∞ptal</button>
                <button class="modal-btn confirm" onclick="joinRoom()">Katƒ±l</button>
            </div>
        </div>
    </div>

    <div id="game-area">
        <div id="player-top" class="player-area">
            <div class="player-info" id="info-top">
                <div class="player-avatar">?</div>
                <div class="player-details">
                    <div class="player-name">Bekleniyor</div>
                    <div class="player-tiles">-- ta≈ü</div>
                </div>
            </div>
        </div>
        <div id="player-left" class="player-area">
            <div class="player-info" id="info-left">
                <div class="player-avatar">?</div>
                <div class="player-details">
                    <div class="player-name">Bekleniyor</div>
                    <div class="player-tiles">-- ta≈ü</div>
                </div>
            </div>
        </div>
        <div id="player-right" class="player-area">
            <div class="player-info" id="info-right">
                <div class="player-avatar">?</div>
                <div class="player-details">
                    <div class="player-name">Bekleniyor</div>
                    <div class="player-tiles">-- ta≈ü</div>
                </div>
            </div>
        </div>
        <div id="center-area">
            <div id="indicator-tile">
                <div class="label">G√∂sterge</div>
                <div class="tile red" id="indicator">?</div>
            </div>
            <div class="pile" id="draw-pile">
                <div class="tile back" onclick="drawTile()"></div>
                <div class="pile-count" id="deck-count">56</div>
                <div class="pile-label">Deste</div>
            </div>
            <div class="pile" id="discard-pile">
                <div class="tile" id="discard-top" style="visibility:hidden;"></div>
                <div class="pile-label">√á√∂p</div>
            </div>
        </div>
        <div id="controls">
            <button class="control-btn sort" onclick="sortTiles('number')">Sayƒ±ya G√∂re</button>
            <button class="control-btn sort" onclick="sortTiles('color')">Renge G√∂re</button>
            <button class="control-btn okey" onclick="checkOkey()" id="okey-btn" disabled>OKEY!</button>
        </div>
        <div id="player-bottom" class="player-area">
            <div class="tile-rack" id="my-tiles"></div>
            <div class="player-info active" id="info-bottom">
                <div class="player-avatar">B</div>
                <div class="player-details">
                    <div class="player-name" id="my-name">Ben</div>
                    <div class="player-tiles" id="my-tile-count">-- ta≈ü</div>
                </div>
            </div>
        </div>
        <div id="turn-indicator"></div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCVnIYIZB__TcudndoCezD6ePPlq6dlqdw",
            authDomain: "okey-oyunu-b4c98.firebaseapp.com",
            databaseURL: "https://okey-oyunu-b4c98-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "okey-oyunu-b4c98",
            storageBucket: "okey-oyunu-b4c98.firebasestorage.app",
            messagingSenderId: "483451129574",
            appId: "1:483451129574:web:42291005cd30c42df33527"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Oyun deƒüi≈ükenleri
        const COLORS = ['red', 'blue', 'yellow', 'black'];
        let gameState = {
            deck: [], players: [{ tiles: [] }, { tiles: [] }, { tiles: [] }, { tiles: [] }],
            currentPlayer: 0, myIndex: 0, indicator: null, okey: null,
            discardPile: [], gameStarted: false, selectedTile: null, hasDrawn: false,
            botCount: 2, isOnline: false, roomId: null, playerNames: ['Ben', 'Bot 1', 'Bot 2', 'Bot 3']
        };
        let roomRef = null, isHost = false, myPlayerId = null;

        // Baƒülantƒ± durumu
        db.ref('.info/connected').on('value', (snap) => {
            const bar = document.getElementById('status-bar');
            if (snap.val() === true) {
                bar.textContent = '‚úÖ Baƒülƒ±';
                bar.className = 'status-bar connected';
            } else {
                bar.textContent = '‚ùå Baƒülantƒ± yok';
                bar.className = 'status-bar disconnected';
            }
        });

        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 4; i++) code += chars[Math.floor(Math.random() * chars.length)];
            return code;
        }

        function showBotModal() { document.getElementById('bot-modal').classList.add('active'); }
        function showCreateModal() { document.getElementById('create-modal').classList.add('active'); }
        function showJoinModal() { document.getElementById('join-modal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function selectBots(n) {
            gameState.botCount = n;
            document.querySelectorAll('.bot-option').forEach(el => el.classList.toggle('selected', parseInt(el.dataset.bots) === n));
        }

        async function createRoom() {
            const name = document.getElementById('host-name').value.trim();
            if (!name) { showToast('L√ºtfen adƒ±nƒ±zƒ± girin!'); return; }

            const code = generateCode();
            gameState.roomId = code;
            gameState.playerNames[0] = name;
            isHost = true;
            myPlayerId = 0;

            roomRef = db.ref('rooms/' + code);

            // Oda var mƒ± kontrol et
            const existing = await roomRef.once('value');
            if (existing.exists()) {
                showToast('Bu kod kullanƒ±mda, tekrar deneyin');
                return createRoom();
            }

            await roomRef.set({
                host: name,
                players: { 0: { name: name, ready: true } },
                status: 'waiting',
                created: Date.now()
            });

            // Sayfa kapatƒ±ldƒ±ƒüƒ±nda odayƒ± sil
            roomRef.onDisconnect().remove();

            document.getElementById('room-code-text').textContent = code;
            document.getElementById('room-display').style.display = 'block';
            document.getElementById('host-players').style.display = 'block';
            document.getElementById('create-btn').textContent = 'Oyunu Ba≈ülat';
            document.getElementById('create-btn').onclick = startOnlineGame;

            // Oyuncu deƒüi≈üikliklerini dinle
            roomRef.child('players').on('value', (snap) => {
                const players = snap.val() || {};
                updatePlayersUI(players);
            });

            // Oyun ba≈üladƒ± mƒ± dinle
            roomRef.child('gameState').on('value', (snap) => {
                if (snap.exists() && !isHost) {
                    loadGameState(snap.val());
                }
            });

            showToast('‚úÖ Oda olu≈üturuldu: ' + code);
        }

        async function joinRoom() {
            const name = document.getElementById('guest-name').value.trim();
            const code = document.getElementById('room-input').value.toUpperCase().trim();

            if (!name) { showToast('L√ºtfen adƒ±nƒ±zƒ± girin!'); return; }
            if (!code || code.length < 4) { showToast('L√ºtfen oda kodunu girin!'); return; }

            roomRef = db.ref('rooms/' + code);
            const snap = await roomRef.once('value');

            if (!snap.exists()) {
                showToast('‚ùå Oda bulunamadƒ±: ' + code);
                return;
            }

            const room = snap.val();
            if (room.status !== 'waiting') {
                showToast('‚ùå Oyun zaten ba≈ülamƒ±≈ü!');
                return;
            }

            // Bo≈ü slot bul
            const players = room.players || {};
            let slot = -1;
            for (let i = 1; i < 4; i++) {
                if (!players[i]) { slot = i; break; }
            }

            if (slot === -1) {
                showToast('‚ùå Oda dolu!');
                return;
            }

            myPlayerId = slot;
            gameState.roomId = code;
            gameState.playerNames[slot] = name;
            isHost = false;

            await roomRef.child('players/' + slot).set({ name: name, ready: true });
            roomRef.child('players/' + slot).onDisconnect().remove();

            // Oyun durumunu dinle
            roomRef.child('gameState').on('value', (snap) => {
                if (snap.exists()) {
                    loadGameState(snap.val());
                }
            });

            // Oyuncu deƒüi≈üikliklerini dinle
            roomRef.child('players').on('value', (snap) => {
                const players = snap.val() || {};
                Object.keys(players).forEach((k, i) => {
                    gameState.playerNames[parseInt(k)] = players[k].name;
                });
            });

            closeModal('join-modal');
            showToast('‚úÖ Odaya katƒ±ldƒ±nƒ±z! Oyun ba≈ülamasƒ± bekleniyor...');

            // Bekle ekranƒ± g√∂ster
            document.getElementById('main-menu').innerHTML = `
            <div class="menu-logo">OKEY</div>
            <div class="menu-subtitle">Oda: ${code}</div>
            <div class="menu-container">
                <p style="color:white; text-align:center;">Oyunun ba≈ülamasƒ± bekleniyor...</p>
                <button class="menu-btn cancel" onclick="leaveRoom()" style="margin-top:20px;">√áƒ±kƒ±≈ü</button>
            </div>
        `;
        }

        function updatePlayersUI(players) {
            const list = document.getElementById('host-players');
            list.innerHTML = '';

            for (let i = 0; i < 4; i++) {
                const p = players[i];
                const slot = document.createElement('div');
                slot.className = 'player-slot' + (p ? ' filled' : '');
                slot.innerHTML = `
                <div class="avatar">${i + 1}</div>
                <div class="name">${p ? p.name : 'Bo≈ü slot'}</div>
                <div class="status">${p ? '‚úì Hazƒ±r' : 'Bekleniyor'}</div>
            `;
                list.appendChild(slot);
                if (p) gameState.playerNames[i] = p.name;
            }
        }

        async function startOnlineGame() {
            if (!isHost) return;

            // Bo≈ü slotlarƒ± botla doldur
            for (let i = 0; i < 4; i++) {
                if (!gameState.playerNames[i] || gameState.playerNames[i] === 'Bo≈ü slot') {
                    gameState.playerNames[i] = 'Bot ' + i;
                }
            }

            gameState.isOnline = true;
            dealTiles();

            // Firebase'e oyun durumunu kaydet
            await roomRef.update({
                status: 'playing',
                gameState: JSON.parse(JSON.stringify(gameState))
            });

            closeModal('create-modal');
            startGame();
        }

        function loadGameState(state) {
            gameState = { ...gameState, ...state };
            gameState.myIndex = myPlayerId;
            closeModal('create-modal');
            closeModal('join-modal');
            startGame();
        }

        function leaveRoom() {
            if (roomRef) {
                if (isHost) {
                    roomRef.remove();
                } else if (myPlayerId !== null) {
                    roomRef.child('players/' + myPlayerId).remove();
                }
                roomRef = null;
            }
            location.reload();
        }

        // ============ OYUN MANTIƒûI ============
        function createDeck() {
            const deck = [];
            for (let i = 0; i < 2; i++) {
                for (const color of COLORS) {
                    for (let num = 1; num <= 13; num++) {
                        deck.push({ color, number: num, isJoker: false });
                    }
                }
            }
            deck.push({ color: 'black', number: 0, isJoker: true });
            deck.push({ color: 'black', number: 0, isJoker: true });
            return shuffle(deck);
        }

        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function dealTiles() {
            gameState.deck = createDeck();
            gameState.indicator = gameState.deck.pop();
            gameState.okey = { color: gameState.indicator.color, number: gameState.indicator.number === 13 ? 1 : gameState.indicator.number + 1 };
            for (let p = 0; p < 4; p++) {
                gameState.players[p].tiles = gameState.deck.splice(0, p === 0 ? 15 : 14);
            }
            gameState.currentPlayer = 0;
            gameState.hasDrawn = true;
            gameState.gameStarted = true;
        }

        function startOfflineGame() {
            gameState.isOnline = false;
            const botNames = ['Bot Ay≈üe', 'Bot Mehmet', 'Bot Zeynep'];
            for (let i = 1; i <= 3; i++) {
                gameState.playerNames[i] = i <= gameState.botCount ? botNames[i - 1] : 'Bo≈ü';
            }
            dealTiles();
            closeModal('bot-modal');
            startGame();
        }

        function startGame() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('game-area').classList.add('active');
            initUI();
            render();
            showToast('Oyun ba≈üladƒ±!');
        }

        function initUI() {
            document.getElementById('my-name').textContent = gameState.playerNames[gameState.myIndex];
            const positions = ['right', 'top', 'left'];
            positions.forEach((pos, i) => {
                const idx = (gameState.myIndex + i + 1) % 4;
                const info = document.getElementById('info-' + pos);
                info.querySelector('.player-name').textContent = gameState.playerNames[idx];
                info.querySelector('.player-avatar').textContent = gameState.playerNames[idx][0];
            });
            document.getElementById('indicator').className = 'tile ' + gameState.indicator.color;
            document.getElementById('indicator').textContent = gameState.indicator.number;
        }

        function render() {
            renderTiles();
            updateInfos();
            document.getElementById('deck-count').textContent = gameState.deck.length;
            updateDiscard();
            updateTurn();
            document.getElementById('okey-btn').disabled = !(gameState.players[gameState.myIndex].tiles.length >= 14 && gameState.currentPlayer === gameState.myIndex);
        }

        function renderTiles() {
            const rack = document.getElementById('my-tiles');
            rack.innerHTML = '';
            gameState.players[gameState.myIndex].tiles.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = 'tile ' + t.color + (t.isJoker ? ' joker' : '');
                div.textContent = t.isJoker ? '‚òÖ' : t.number;
                div.onclick = () => selectTile(i);
                if (t.color === gameState.okey.color && t.number === gameState.okey.number) {
                    div.style.boxShadow = '0 0 15px gold';
                }
                rack.appendChild(div);
            });
            document.getElementById('my-tile-count').textContent = gameState.players[gameState.myIndex].tiles.length + ' ta≈ü';
        }

        function updateInfos() {
            const positions = ['bottom', 'right', 'top', 'left'];
            positions.forEach((pos, i) => {
                const idx = (gameState.myIndex + i) % 4;
                const info = document.getElementById('info-' + pos);
                info.classList.toggle('active', idx === gameState.currentPlayer);
                info.querySelector('.player-tiles').textContent = gameState.players[idx].tiles.length + ' ta≈ü';
            });
        }

        function updateDiscard() {
            const el = document.getElementById('discard-top');
            if (gameState.discardPile.length > 0) {
                const t = gameState.discardPile[gameState.discardPile.length - 1];
                el.style.visibility = 'visible';
                el.className = 'tile ' + t.color;
                el.textContent = t.isJoker ? '‚òÖ' : t.number;
                el.onclick = drawFromDiscard;
            } else {
                el.style.visibility = 'hidden';
            }
        }

        function updateTurn() {
            const el = document.getElementById('turn-indicator');
            if (gameState.currentPlayer === gameState.myIndex) {
                el.textContent = gameState.hasDrawn ? 'üÉè Bir ta≈ü atƒ±n!' : 'üì• Ta≈ü √ßekin!';
                el.style.display = 'block';
            } else {
                el.textContent = gameState.playerNames[gameState.currentPlayer] + ' oynuyor...';
                el.style.display = 'block';
            }
        }

        function selectTile(idx) {
            if (gameState.currentPlayer !== gameState.myIndex || !gameState.hasDrawn) {
                showToast(gameState.hasDrawn ? 'Sƒ±ra sizde deƒüil!' : '√ñnce ta≈ü √ßekin!');
                return;
            }
            if (gameState.selectedTile === idx) {
                discardTile(idx);
            } else {
                document.querySelectorAll('.tile.selected').forEach(t => t.classList.remove('selected'));
                gameState.selectedTile = idx;
                document.getElementById('my-tiles').children[idx]?.classList.add('selected');
                showToast('Atmak i√ßin tekrar tƒ±klayƒ±n');
            }
        }

        function discardTile(idx) {
            const tile = gameState.players[gameState.myIndex].tiles.splice(idx, 1)[0];
            gameState.discardPile.push(tile);
            gameState.selectedTile = null;
            gameState.hasDrawn = false;
            syncAndNext();
        }

        function drawTile() {
            if (gameState.currentPlayer !== gameState.myIndex) { showToast('Sƒ±ra sizde deƒüil!'); return; }
            if (gameState.hasDrawn) { showToast('Zaten ta≈ü √ßektiniz!'); return; }
            if (gameState.deck.length === 0) { showToast('Deste bitti!'); return; }
            gameState.players[gameState.myIndex].tiles.push(gameState.deck.pop());
            gameState.hasDrawn = true;
            render();
            syncState();
        }

        function drawFromDiscard() {
            if (gameState.currentPlayer !== gameState.myIndex || gameState.hasDrawn) return;
            if (gameState.discardPile.length === 0) return;
            gameState.players[gameState.myIndex].tiles.push(gameState.discardPile.pop());
            gameState.hasDrawn = true;
            render();
            syncState();
        }

        function syncAndNext() {
            nextPlayer();
            render();
            syncState();
        }

        function nextPlayer() {
            gameState.currentPlayer = (gameState.currentPlayer + 1) % 4;
            while (!gameState.isOnline && gameState.currentPlayer !== gameState.myIndex && gameState.playerNames[gameState.currentPlayer].startsWith('Bo≈ü')) {
                gameState.currentPlayer = (gameState.currentPlayer + 1) % 4;
            }
            gameState.hasDrawn = false;
            if (!gameState.isOnline && gameState.currentPlayer !== gameState.myIndex) {
                setTimeout(() => botPlay(gameState.currentPlayer), 1000);
            }
        }

        function botPlay(idx) {
            if (!gameState.gameStarted || gameState.playerNames[idx].startsWith('Bo≈ü')) return;
            if (gameState.deck.length > 0) gameState.players[idx].tiles.push(gameState.deck.pop());
            if (gameState.players[idx].tiles.length > 0) {
                const ri = Math.floor(Math.random() * gameState.players[idx].tiles.length);
                gameState.discardPile.push(gameState.players[idx].tiles.splice(ri, 1)[0]);
            }
            render();
            setTimeout(() => { nextPlayer(); render(); }, 500);
        }

        function syncState() {
            if (gameState.isOnline && roomRef) {
                roomRef.child('gameState').set(JSON.parse(JSON.stringify(gameState)));
            }
        }

        function sortTiles(by) {
            const tiles = gameState.players[gameState.myIndex].tiles;
            tiles.sort((a, b) => {
                if (a.isJoker) return 1; if (b.isJoker) return -1;
                return by === 'number'
                    ? a.number - b.number || COLORS.indexOf(a.color) - COLORS.indexOf(b.color)
                    : COLORS.indexOf(a.color) - COLORS.indexOf(b.color) || a.number - b.number;
            });
            renderTiles();
        }

        function checkOkey() {
            const tiles = gameState.players[gameState.myIndex].tiles;
            if (tiles.length < 14) { showToast('Yeterli ta≈ü yok!'); return; }
            // Basit kontrol
            showToast('üéâ OKEY! Tebrikler!', 5000);
            gameState.gameStarted = false;
            setTimeout(() => { if (confirm('Kazandƒ±nƒ±z! Yeni oyun?')) location.reload(); }, 1000);
        }

        function showToast(msg, dur = 3000) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', dur);
        }
    </script>
</body>

</html>